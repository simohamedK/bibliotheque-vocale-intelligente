<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioth√®que Vocale Intelligente</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; background-color: #f9f9f9; }
        h1, h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        #controls, #upload-controls { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 30px;}
        input[type="text"] { width: 300px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-top: 5px; }
        input[type="file"] { margin-top: 10px; }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; background-color: #007bff; color: white; }
        button:hover { background-color: #0056b3; }
        #btnParler { background-color: #28a745; }
        #btnParler:hover { background-color: #218838; }
        #listeResultats, #listeMedias { list-style-type: none; padding: 0; }
        #listeResultats li, #listeMedias li { background-color: #fff; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 20px; }
        #listeResultats strong, #listeMedias strong { display: block; font-size: 1.2em; color: #0056b3; margin-bottom: 5px; }
        #listeResultats button { margin-left: 10px; background-color: #ffc107; color: black; }
        #listeResultats button:hover { background-color: #e0a800; }
        #statutVoix, #statutUpload { margin-top:10px; font-style: italic; color: #555; }
    </style>
</head>
<body>

    <h1>üìö Biblioth√®que Vocale Intelligente</h1>

    <div id="controls">
        <p>Recherchez un livre par la voix ou au clavier, puis √©coutez le r√©sum√©.</p>
        <button id="btnParler">Parler üéôÔ∏è</button>
        <input type="text" id="champRecherche" placeholder="Ou tapez votre recherche...">
        <button id="btnRechercher">Rechercher üîç</button>
        <div id="statutVoix"></div>
    </div>

    <h2>R√©sultats de la recherche :</h2>
    <ul id="listeResultats"></ul>

    
    <h2>M√©dias R√©cemment Ajout√©s :</h2>
    <ul id="listeMedias">
        </ul>


    <div id="upload-controls">
        <h2>Ajouter un nouveau m√©dia (Audio/Vid√©o)</h2>
        <p>Ajoutez un fichier (audio/vid√©o) √† Omeka S. Il sera cr√©√© comme un nouvel "Item" avec ce fichier attach√©.</p>
        <div>
            <label for="mediaTitre">Titre du m√©dia :</label><br>
            <input type="text" id="mediaTitre" placeholder="Ex: Mon enregistrement audio" style="width: 300px;">
        </div>
        <div style="margin-top: 15px;">
            <label for="mediaFichier">Fichier (audio ou vid√©o) :</label><br>
            <input type="file" id="mediaFichier" accept="audio/*,video/*">
        </div>
        <div style="margin-top: 20px;">
            <button id="btnUploadMedia">Uploader le M√©dia üì§</button>
        </div>
        <div id="statutUpload"></div>
    </div>
    
    
    <script>
        // --- 1. CONFIGURATION OBLIGATOIRE (REMPLIE AVEC VOS INFORMATIONS) ---

        const OMEKA_API_URL = "http://localhost/omk_THyp_25-26_clone/api/"; // <-- URL MISE √Ä JOUR
        
        // --- Cl√©s d'API ---
        const API_KEY_IDENTITY = "tNpFTjx4GnkWGa2Hduf0ti3kIwIKiN1Y";
        const API_KEY_CREDENTIAL = "LIcwTBnUOyRIiNtToTz5OnJ1heSn6IcB";

        // --- IDs de votre Admin Omeka ---
        const ID_MODELE_LOG_RECHERCHE = 5;    // ID Mod√®le "Log Recherche"
        const ID_CLASSE_LIVRE = 1045;         // ID Classe "schema:Book" (pour le filtre)
        
        // REMPLACEZ 0 PAR L'ID DE schema:MediaObject (voir √©tape 2 du message pr√©c√©dent)
        const ID_CLASSE_MEDIA = 747;          // ID Classe "schema:MediaObject" (pour les uploads m√©dias)
        
        const ID_PROP_TERME = 185;      // ID pour "bvi:termeRecherche"
        const ID_PROP_SOURCE = 186;     // ID pour "bvi:sourceRecherche"
        const ID_PROP_CONFIANCE = 187;  // ID pour "bvi:confianceScore"
        const ID_PROP_DATE = 7;         // ID pour "dcterms:date"


        // --- 2. √âL√âMENTS DE LA PAGE (Recherche) ---
        const btnParler = document.getElementById('btnParler');
        const btnRechercher = document.getElementById('btnRechercher');
        const champRecherche = document.getElementById('champRecherche');
        const listeResultats = d3.select('#listeResultats');
        const statutVoix = document.getElementById('statutVoix');
        
        // --- 3. √âL√âMENTS DE LA PAGE (Upload) ---
        const btnUploadMedia = document.getElementById('btnUploadMedia');
        const mediaTitre = document.getElementById('mediaTitre');
        const mediaFichier = document.getElementById('mediaFichier');
        const statutUpload = document.getElementById('statutUpload');
        const listeMedias = d3.select('#listeMedias');


        // --- 4. RECHERCHE VOCALE (Web Speech API) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'fr-FR'; 

            btnParler.onclick = () => {
                statutVoix.textContent = "Je vous √©coute...";
                recognition.start();
            };

            recognition.onresult = (event) => {
                const rawTranscript = event.results[0][0].transcript; // ex: "Les Mis√©rables."
                const confidence = event.results[0][0].confidence;
                
                // CORRECTION : Supprimer le point final
                const transcript = rawTranscript.replace(/\.$/, ''); // ex: "Les Mis√©rables"

                statutVoix.textContent = `Vous avez dit : "${transcript}"`;
                champRecherche.value = transcript; 
                
                rechercherLivres(transcript); 
                journaliserRecherche(transcript, 'voix', confidence); 
            };
            
            recognition.onerror = (event) => {
                statutVoix.textContent = "Erreur de reconnaissance vocale: " + event.error;
                console.error("Erreur SpeechRecognition:", event);
            };

            recognition.onspeechend = () => {
                recognition.stop();
            };

        } else {
            btnParler.disabled = true;
            statutVoix.textContent = "API Web Speech non support√©e sur ce navigateur (essayez Chrome ou Edge).";
        }


        // --- 5. RECHERCHE TEXTE (Bouton) ---
        btnRechercher.onclick = () => {
            const terme = champRecherche.value;
            if (terme) {
                statutVoix.textContent = "";
                rechercherLivres(terme);
                journaliserRecherche(terme, 'texte', null); 
            }
        };


        // --- 6. FONCTION DE RECHERCHE OMEKA S (LIRE les donn√©es) ---
        function rechercherLivres(terme) {
            // CORRECTION : Ajout du filtre resource_class_id pour n'avoir que les livres
            const url = `${OMEKA_API_URL}items?resource_class_id=${ID_CLASSE_LIVRE}&search=${encodeURIComponent(terme)}`;
            
            listeResultats.html('<li>Chargement...</li>');
            
            d3.json(url).then(data => {
                listeResultats.html(''); 
                
                if (!data || data.length === 0) {
                    listeResultats.append('li').text("Aucun livre trouv√© pour ce terme.");
                    return;
                }
                
                data.forEach(item => {
                    const titre = item['o:title'] || "Titre inconnu";
                    const resume = item['dcterms:abstract'] ? item['dcterms:abstract'][0]['@value'] : "Pas de r√©sum√©.";
                    
                    const li = listeResultats.append('li')
                        .html(`<strong>${titre}</strong><br>${resume}`);
                    
                    li.append('button').text('√âcouter üîä').on('click', () => {
                        parlerTexte(`${titre}. R√©sum√© : ${resume}`);
                    });
                });
            }).catch(err => {
                listeResultats.html('<li>Erreur lors du chargement des r√©sultats.</li>');
                console.error("Erreur D3/Fetch:", err);
            });
        }


        // --- 7. FONCTION DE NARRATION (Text-to-Speech) ---
        function parlerTexte(texte) {
            window.speechSynthesis.cancel(); 
            const narration = new SpeechSynthesisUtterance(texte);
            narration.lang = 'fr-FR';
            // CORRECTION : faute de frappe "naraction" corrig√©e
            window.speechSynthesis.speak(narration);
        }
        

        // --- 8. FONCTION DE JOURNALISATION OMEKA S (√âCRIRE des logs) ---
        async function journaliserRecherche(terme, source, confiance) {
            console.log(`Journalisation : ${terme} (source: ${source})`);

            const authParams = `?key_identity=${API_KEY_IDENTITY}&key_credential=${API_KEY_CREDENTIAL}`;
            const url = `${OMEKA_API_URL}items${authParams}`;

            let data = {
                "o:resource_template": { "o:id": ID_MODELE_LOG_RECHERCHE },
                "dcterms:title": `Recherche : "${terme}"`,
                "bvi:termeRecherche": [{ "type": "literal", "property_id": ID_PROP_TERME, "@value": terme }],
                "bvi:sourceRecherche": [{ "type": "literal", "property_id": ID_PROP_SOURCE, "@value": source }],
                "dcterms:date": [{ "type": "literal", "property_id": ID_PROP_DATE, "@value": new Date().toISOString() }]
            };

            if (confiance) {
                data["bvi:confianceScore"] = [{ "type": "literal", "property_id": ID_PROP_CONFIANCE, "@value": confiance }];
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error("Erreur de journalisation:", error.errors.error);
                } else {
                    const newItem = await response.json();
                    console.log("Recherche journalis√©e avec succ√®s ! Item cr√©√©:", newItem['o:id']);
                }
            } catch (err) {
                console.error("Erreur r√©seau lors de la journalisation:", err);
            }
        }
        
        
        // --- 9. NOUVELLE PARTIE (FONCTIONS D'UPLOAD M√âDIA) ---

        // Mettre un √©couteur sur le nouveau bouton
        btnUploadMedia.onclick = () => {
            const titre = mediaTitre.value;
            const fichier = mediaFichier.files[0];

            if (ID_CLASSE_MEDIA === 0) {
                statutUpload.textContent = "Erreur : Veuillez d'abord configurer l'ID_CLASSE_MEDIA dans le script.";
                return;
            }
            if (!titre || !fichier) {
                statutUpload.textContent = "Erreur : Le titre et le fichier sont obligatoires.";
                return;
            }
            ajouterNouveauMedia(titre, fichier);
        };
        
        /**
         * Affiche la liste des 5 m√©dias les plus r√©cents
         */
        async function afficherMediasRecents() {
            if (ID_CLASSE_MEDIA === 0) {
                listeMedias.html('<li>Veuillez configurer l\'ID_CLASSE_MEDIA dans le script.</li>');
                return;
            }
            
            statutUpload.textContent = "Chargement des m√©dias...";
            
            // On cherche les 5 items de la classe M√©dia, tri√©s par date de cr√©ation (du + r√©cent au + ancien)
            const url = `${OMEKA_API_URL}items?resource_class_id=${ID_CLASSE_MEDIA}&sort_by=created&sort_order=desc&limit=5`;

            try {
                const data = await d3.json(url);
                listeMedias.html(''); // Vider la liste

                if (!data || data.length === 0) {
                    listeMedias.append('li').text("Aucun m√©dia n'a encore √©t√© ajout√©.");
                    return;
                }

                // Afficher chaque m√©dia
                data.forEach(item => {
                    const titre = item['o:title'] || "[M√©dia sans titre]";
                    const mediaCount = item['o:media'] ? item['o:media'].length : 0;
                    
                    const li = listeMedias.append('li')
                        .html(`<strong>${titre}</strong><br> (ID: ${item['o:id']}) - ${mediaCount} fichier(s) attach√©(s)`);
                    
                    // Ajouter un lien vers l'admin pour le voir
                    li.append('a')
                        .attr('href', item['@id'].replace('/api/items/', '/admin/item/'))
                        .attr('target', '_blank')
                        .text(' (Voir dans Omeka)')
                        .style('margin-left', '10px');
                });
                statutUpload.textContent = "Liste des m√©dias √† jour.";

            } catch (err) {
                console.error("Erreur (afficherMediasRecents):", err);
                listeMedias.html('<li>Erreur lors du chargement des m√©dias.</li>');
            }
        }

        /**
         * Uploade un m√©dia (√âtape A) puis cr√©e un item (√âtape B)
         */
        async function ajouterNouveauMedia(titre, fichier) {
            statutUpload.textContent = `√âtape 1/2 : Upload de "${fichier.name}" en cours...`;

            // --- √âTAPE A: UPLOAD DU FICHIER (POST /api/media) ---
            
            const authParams = `?key_identity=${API_KEY_IDENTITY}&key_credential=${API_KEY_CREDENTIAL}`;
            const mediaUrl = `${OMEKA_API_URL}media${authParams}`;
            const itemsUrl = `${OMEKA_API_URL}items${authParams}`;

            const formData = new FormData();
            formData.append('file', fichier); // Juste le fichier

            let mediaId = null;

            try {
                // 1. Envoyer le fichier
                const responseMedia = await fetch(mediaUrl, {
                    method: 'POST',
                    body: formData
                });

                if (!responseMedia.ok) {
                    const error = await responseMedia.json();
                    console.error("Erreur (√âtape A: Upload M√©dia):", error);
                    statutUpload.textContent = "Erreur lors de l'upload du fichier.";
                    return; // Arr√™ter s'il y a une erreur
                }
                
                const media = await responseMedia.json();
                mediaId = media['o:id']; // R√©cup√©rer l'ID du m√©dia upload√©
                console.log("√âtape 1/2 R√©ussie. M√©dia ID:", mediaId);
                statutUpload.textContent = "√âtape 2/2 : Cr√©ation de l'item...";

            } catch (err) {
                console.error("Erreur r√©seau (√âtape A):", err);
                statutUpload.textContent = "Erreur r√©seau lors de l'upload.";
                return;
            }

            // --- √âTAPE B: CR√âATION DE L'ITEM (POST /api/items) ---
            
            // 2. Pr√©parer les donn√©es JSON pour le nouvel item
            const jsonData = {
                "dcterms:title": [{ "type": "literal", "@value": titre }],
                // Attacher le m√©dia que nous venons d'uploader
                "o:media": [
                    { "o:id": mediaId } 
                ],
                // Attacher la classe "M√©dia"
                "o:resource_class": { "o:id": ID_CLASSE_MEDIA }
            };

            // 3. Envoyer la requ√™te de cr√©ation d'item
            try {
                const responseItem = await fetch(itemsUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jsonData)
                });

                if (!responseItem.ok) {
                    const error = await responseItem.json();
                    console.error("Erreur (√âtape B: Cr√©ation Item):", error);
                    statutUpload.textContent = "Erreur lors de la cr√©ation de l'item.";
                } else {
                    const newItem = await responseItem.json();
                    console.log("√âtape 2/2 R√©ussie. Item cr√©√©:", newItem['o:id']);
                    statutUpload.textContent = `Succ√®s ! Le fichier "${fichier.name}" a √©t√© ajout√© (Item ID: ${newItem['o:id']}).`;
                    
                    // Vider les champs
                    mediaTitre.value = "";
                    mediaFichier.value = null;
                    
                    // Raffra√Æchir la liste des m√©dias
                    afficherMediasRecents(); 
                }
            } catch (err) {
                console.error("Erreur r√©seau (√âtape B):", err);
                statutUpload.textContent = "Erreur r√©seau lors de la cr√©ation de l'item.";
            }
        }
        
        
        // --- 10. D√âMARRAGE ---
        // Charger les m√©dias existants au d√©marrage de la page
        afficherMediasRecents();

    </script>
</body>
</html>