<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioth√®que Vocale Intelligente</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; background-color: #f9f9f9; }
        h1 { color: #333; }
        #controls { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #champRecherche { width: 300px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; background-color: #007bff; color: white; }
        button:hover { background-color: #0056b3; }
        #btnParler { background-color: #28a745; }
        #btnParler:hover { background-color: #218838; }
        #listeResultats { list-style-type: none; padding: 0; margin-top: 20px; }
        #listeResultats li { background-color: #fff; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 20px; }
        #listeResultats strong { display: block; font-size: 1.2em; color: #0056b3; margin-bottom: 5px; }
        #listeResultats button { margin-left: 10px; background-color: #ffc107; color: black; }
        #listeResultats button:hover { background-color: #e0a800; }
        #statutVoix { margin-top:10px; font-style: italic; color: #555; }
    </style>
</head>
<body>

    <h1>üìö Biblioth√®que Vocale Intelligente</h1>
    <p>Recherchez un livre par la voix ou au clavier, puis √©coutez le r√©sum√©.</p>

    <div id="controls">
        <button id="btnParler">Parler üéôÔ∏è</button>
        <input type="text" id="champRecherche" placeholder="Ou tapez votre recherche...">
        <button id="btnRechercher">Rechercher üîç</button>
        <div id="statutVoix"></div>
    </div>

    <h2>R√©sultats :</h2>
    <ul id="listeResultats"></ul>

    <script>
        // Note: J'ai enlev√© "type=module" pour √©viter les probl√®mes CORS avec les modules 'auth.js'.
        // Ce script est maintenant autonome.

        // --- 1. CONFIGURATION OBLIGATOIRE (REMPLIE AVEC VOS INFORMATIONS) ---

        const OMEKA_API_URL = "http://localhost/omk_THyp_25-26_clone/api/"; 
        
        // --- Cl√©s d'API (Trouv√©es √† l'√©tape 1) ---
        const API_KEY_IDENTITY = "tNpFTjx4GnkWGa2Hduf0ti3kIwIKiN1Y";
        const API_KEY_CREDENTIAL = "LIcwTBnUOyRIiNtToTz5OnJ1heSn6IcB";

        // --- IDs de votre Admin Omeka (Trouv√©s √† l'√©tape 2) ---
        const ID_MODELE_LOG_RECHERCHE = 5; // ID Mod√®le "Log Recherche"
        
        const ID_PROP_TERME = 185;      // ID pour "bvi:termeRecherche"
        const ID_PROP_SOURCE = 186;     // ID pour "bvi:sourceRecherche"
        const ID_PROP_CONFIANCE = 187;  // ID pour "bvi:confianceScore"
        const ID_PROP_DATE = 7;         // ID pour "dcterms:date"


        // --- 2. √âL√âMENTS DE LA PAGE ---
        const btnParler = document.getElementById('btnParler');
        const btnRechercher = document.getElementById('btnRechercher');
        const champRecherche = document.getElementById('champRecherche');
        const listeResultats = d3.select('#listeResultats');
        const statutVoix = document.getElementById('statutVoix');


        // --- 3. RECHERCHE VOCALE (Web Speech API) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'fr-FR'; // Langue fran√ßaise

            btnParler.onclick = () => {
                statutVoix.textContent = "Je vous √©coute...";
                recognition.start();
            };

            // Quand la voix est reconnue
            recognition.onresult = (event) => {
              const rawTranscript = event.results[0][0].transcript; // ex: "Les Mis√©rables."
              const confidence = event.results[0][0].confidence;

              // L'API ajoute un point final. On le supprime avant la recherche.
              const transcript = rawTranscript.replace(/\.$/, ''); // ex: "Les Mis√©rables"

              statutVoix.textContent = `Vous avez dit : "${transcript}"`;
              champRecherche.value = transcript; // Mettre le texte NETTOY√â dans le champ

              rechercherLivres(transcript); // Lancer la recherche avec le texte NETTOY√â
              journaliserRecherche(transcript, 'voix', confidence); // Journaliser avec le texte NETTOY√â
          };
            
            recognition.onerror = (event) => {
                statutVoix.textContent = "Erreur de reconnaissance vocale: " + event.error;
                console.error("Erreur SpeechRecognition:", event);
            };

            recognition.onspeechend = () => {
                recognition.stop();
            };

        } else {
            // Si l'API n'est pas support√©e
            btnParler.disabled = true;
            statutVoix.textContent = "API Web Speech non support√©e sur ce navigateur (essayez Chrome ou Edge).";
        }


        // --- 4. RECHERCHE TEXTE (Bouton) ---
        btnRechercher.onclick = () => {
            const terme = champRecherche.value;
            if (terme) {
                statutVoix.textContent = "";
                rechercherLivres(terme);
                journaliserRecherche(terme, 'texte', null); // Pas de score de confiance
            }
        };


        // --- 5. FONCTION DE RECHERCHE OMEKA S (LIRE les donn√©es) ---
        function rechercherLivres(terme) {
            // Interroge l'API Omeka S pour trouver des items (pas besoin de cl√© pour LIRE)
            const url = `${OMEKA_API_URL}items?resource_class_id=1045&search=${encodeURIComponent(terme)}`;
            
            listeResultats.html('<li>Chargement...</li>'); // Message d'attente
            
            d3.json(url).then(data => {
                listeResultats.html(''); // Vider la liste
                
                if (!data || data.length === 0) {
                    listeResultats.append('li').text("Aucun livre trouv√© pour ce terme.");
                    return;
                }
                
                // Afficher chaque r√©sultat
                data.forEach(item => {
                    const titre = item['o:title'] || "Titre inconnu";
                    // Le r√©sum√© est dans 'dcterms:abstract' (un tableau)
                    const resume = item['dcterms:abstract'] ? item['dcterms:abstract'][0]['@value'] : "Pas de r√©sum√©.";
                    
                    const li = listeResultats.append('li')
                        .html(`<strong>${titre}</strong><br>${resume}`);
                    
                    // Bouton NARRATION (Text-to-Speech)
                    li.append('button').text('√âcouter üîä').on('click', () => {
                        parlerTexte(`${titre}. R√©sum√© : ${resume}`);
                    });
                });
            }).catch(err => {
                listeResultats.html('<li>Erreur lors du chargement des r√©sultats.</li>');
                console.error("Erreur D3/Fetch:", err);
            });
        }


        // --- 6. FONCTION DE NARRATION (Text-to-Speech) ---
        function parlerTexte(texte) {
            // Annule la lecture pr√©c√©dente
            window.speechSynthesis.cancel(); 
            
            const narration = new SpeechSynthesisUtterance(texte);
            narration.lang = 'fr-FR'; // Langue fran√ßaise
            window.speechSynthesis.speak(narration);
        }
        

        // --- 7. FONCTION DE JOURNALISATION OMEKA S (√âCRIRE des donn√©es) ---
        async function journaliserRecherche(terme, source, confiance) {
            console.log(`Journalisation : ${terme} (source: ${source})`);

            // 1. Construire l'URL d'authentification
            const authParams = `?key_identity=${API_KEY_IDENTITY}&key_credential=${API_KEY_CREDENTIAL}`;
            const url = `${OMEKA_API_URL}items${authParams}`;

            // 2. Pr√©parer les donn√©es JSON (comme dans l'exemple du prof)
            let data = {
                "o:resource_template": { "o:id": ID_MODELE_LOG_RECHERCHE },
                "dcterms:title": `Recherche : "${terme}"`, // Titre pour l'item Omeka
                
                // --- Propri√©t√©s personnalis√©es ---
                "bvi:termeRecherche": [{ 
                    "type": "literal", 
                    "property_id": ID_PROP_TERME, 
                    "@value": terme 
                }],
                "bvi:sourceRecherche": [{ 
                    "type": "literal", 
                    "property_id": ID_PROP_SOURCE, 
                    "@value": source 
                }],
                "dcterms:date": [{ 
                    "type": "literal", 
                    "property_id": ID_PROP_DATE, 
                    "@value": new Date().toISOString() // Date actuelle
                }]
            };

            // 3. Ajouter le score de confiance SEULEMENT si ce n'est pas nul (recherche vocale)
            if (confiance) {
                data["bvi:confianceScore"] = [{ 
                    "type": "literal", 
                    "property_id": ID_PROP_CONFIANCE, 
                    "@value": confiance 
                }];
            }
            
            // 4. Envoyer la requ√™te "POST" (√âCRIRE)
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    // Si l'API renvoie une erreur (ex: cl√© API incorrecte)
                    const error = await response.json();
                    console.error("Erreur de journalisation:", error.errors.error);
                } else {
                    const newItem = await response.json();
                    console.log("Recherche journalis√©e avec succ√®s ! Item cr√©√©:", newItem['o:id']);
                }
            } catch (err) {
                console.error("Erreur r√©seau lors de la journalisation:", err);
            }
        }
        
    </script>
</body>
</html>